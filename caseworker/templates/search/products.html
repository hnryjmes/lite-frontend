{% extends 'layouts/base.html' %}
{% load crispy_forms_tags %}
{% load parse_date from spire_tags %}

{% block back_link %}{% endblock %}

{% block title %}
    Search - Products
{% endblock %}

{% block body %}
    <div class="lite-app-bar govuk-!-margin-bottom-0">
        <div class="lite-app-bar__content">
            <h1 class="govuk-heading-l">Search products</h1>
        </div>
    </div>

    <div class="govuk-!-margin-top-4">
        <div class="search-div">
            <div class="product-search">
                {% crispy form %}
            </div>
        </div>
    </div>

    <section class="search-results govuk-!-margin-top-4">
        {% if search_results.count %}
            <h1 class="govuk-body">{{ search_results.count }} products found</h1>
        {% endif %}
        {% for good in search_results.results %}
            <article class="search-result">
                <header class="search-result__header">
                    <div class="search-result__header-wrapper">
                        <h1 class="search-result__product-name govuk-heading-m">{{ good.name }}</h1>
                        <div class="search-result__company-name">{{ good.organisation }}</div>
                    </div>
                    {% if good.part_number %}
                        <div class="search-result__part-number">{{ good.part_number }}</div>
                    {% endif %}
                </header>
                <table class="govuk-table">
                    <thead class="govuk-table__head">
                        <tr class="govuk-table__row">
                            <th scope="col" class="govuk-table__header">
                                Case reference
                            </th>
                            <th scope="col" class="govuk-table__header">
                                Assessment date
                            </th>
                            <th scope="col" class="govuk-table__header">
                                Destination
                            </th>
                            <th scope="col" class="govuk-table__header">
                                Control entry
                            </th>
                            <th scope="col" class="govuk-table__header">
                                Report summary
                            </th>
                            <th scope="col" class="govuk-table__header">
                                Assessment notes
                            </th>
                        </tr>
                    </thead>
                    <tbody class="govuk-table__body">
                        {% for good_on_application in good.distinct_rating_hits %}
                            <tr class="govuk-table__row">
                                <th scope="row" class="govuk-table__cell govuk-body">
                                    <a class="govuk-link govuk-link--no-visited-state" href="{% url 'cases:tau:home' ALL_CASES_QUEUE_ID good_on_application.application.id %}">
                                        <span class="govuk-visually-hidden">View</span> {{ good_on_application.application.reference_code }}
                                    </a>
                                </th>
                                <td class="govuk-table__cell">{{ good_on_application.assessment_date|parse_date|date:"d M Y" }}</td>
                                <td class="govuk-table__cell">{{ good_on_application.destination }}</td>
                                <td class="govuk-table__cell">{% for cle in good_on_application.control_list_entries %}{{ cle.rating }}{% if not forloop.last %}, {% endif %}{% endfor %}</td>
                                <td class="govuk-table__cell">{{ good_on_application.report_summary|default:"" }}</td>
                                <td class="govuk-table__cell">{{ good_on_application.rating_comment|default:"" }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% if good.remaining_hits|length %}
                    <div class="product-search-cle-remaining-hits">
                        <details class="govuk-details" data-module="govuk-details">
                            <summary class="govuk-details__summary">
                            <span class="govuk-details__summary-text">
                                Show more cases for this product
                            </span>
                            </summary>
                            <div class="govuk-details__text">
                                <table class="govuk-table">
                                    <tbody class="govuk-table__body">
                                        {% for good_on_application in good.remaining_hits %}
                                            <tr class="govuk-table__row">
                                                <th scope="row" class="govuk-table__cell govuk-body">
                                                    <a class="govuk-link govuk-link--no-visited-state" href="{% url 'cases:case' ALL_CASES_QUEUE_ID good_on_application.application.id %}">
                                                        <span class="govuk-visually-hidden">View</span> {{ good_on_application.application.reference_code }}
                                                    </a>
                                                </th>
                                                <td class="govuk-table__cell">{{ good_on_application.assessment_date|parse_date|date:"d M Y" }}</td>
                                                <td class="govuk-table__cell">{{ good_on_application.destination }}</td>
                                                <td class="govuk-table__cell">{% for cle in good_on_application.control_list_entries %}{{ cle.rating }}{% if not forloop.last %}, {% endif %}{% endfor %}</td>
                                                <td class="govuk-table__cell">{{ good_on_application.report_summary|default:"" }}</td>
                                                <td class="govuk-table__cell">{{ good_on_application.rating_comment|default:"" }}</td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </details>
                    </div>
                {% endif %}
            </article>
        {% endfor %}

        {% pagination %}
    </section>
{% endblock %}
